<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Settings</title>

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Icons"
        />

        <?!= style ?>
    </head>

    <body>
        <header>
            <div class="nav-wrapper valign-wrapper col s12 light-blue darken-3">
                <div class="container">
                    <h5 class="white-text">Settings</h5>
                </div>
            </div>
            <div class="preload-wrapper">
                <div id="preload" class="progress light-blue darken-3">
                    <div class="indeterminate white"></div>
                </div>
            </div>
        </header>

        <main>
            <div class="container">
                <div class="row dense">
                    <div class="col s12">
                        <div class="input-field">
                            <input
                                id="clearAt"
                                name="clearAt"
                                placeholder="00:00"
                                type="text"
                                class="timepicker tooltipped"
                                data-position="bottom"
                                data-tooltip="Time when the sheet is cleared"
                            />
                            <label for="clearAt">Clear At</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        <a
                            id="clearNow"
                            class="waves-effect light-blue darken-3 btn"
                            >Clear Now</a
                        >
                    </div>
                </div>
                <div class="row valign-wrapper">
                    <div class="col s10">
                        <p class="dense" for="clear">Discard data daily</p>
                    </div>
                    <div class="col s2">
                        <div class="switch">
                            <label>
                                <input
                                    id="clear"
                                    name="enableDailyClear"
                                    type="checkbox"
                                />
                                <span class="lever right"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row valign-wrapper">
                    <div class="col s10">
                        <p class="dense" for="edit">Enable edit trigger</p>
                    </div>
                    <div class="col s2">
                        <div class="switch">
                            <label>
                                <input
                                    id="edit"
                                    name="enableEditTrigger"
                                    type="checkbox"
                                />
                                <span class="lever right"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input
                            id="gaid"
                            type="text"
                            class="validate tooltipped"
                            data-position="bottom"
                            data-tooltip="Your Google Analytics Id"
                        />
                        <label for="gaid">Analytics Id</label>
                    </div>
                    <!-- <div class="input-field col s12">
            <select id="adsid">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Google Ads Account</label>
          </div> -->
                </div>
                <div class="row">
                    <div class="col s12">
                        <a
                            id="reset"
                            class="waves-effect light-blue darken-3 btn"
                            >Reset</a
                        >
                    </div>
                </div>
            </div>
        </main>

        <?!= run ?>
        <?!= utils ?>

        <script>
            (() => {
                const primBckg = "primary-background";
                const failureBckg = "failure-background";
                const hideCls = "hidden";

                const initTooltipped = (options = {}) => {
                    const elems = document.querySelectorAll(".tooltipped");
                    return M.Tooltip.init(elems, options);
                };

                window.addEventListener(
                    "error",
                    async (/** @type {ErrorEvent} */ ev) => {
                        const { message = "unknown error" } = ev;

                        await gscript("logException", "settings", message);

                        notify("Something went wrong!", failureBckg);
                    }
                );

                window.addEventListener(
                    "unhandledrejection",
                    async (/** @type {PromiseRejectionEvent} */ ev) => {
                        const {
                            reason: {
                                name = "Error",
                                message = "unknown rejection",
                            },
                        } = ev;

                        await gscript(
                            "logException",
                            "settings",
                            `${name} | ${message}`
                        );

                        notify("Something went wrong!", failureBckg);
                    }
                );

                window.addEventListener("DOMContentLoaded", async (ev) => {
                    M.AutoInit();

                    await gscript(
                        "sendPageview",
                        getCid(),
                        "{{page_url}}",
                        "{{page_title}}",
                        "{{page_path}}"
                    );

                    const preloader = document.querySelector("#preload");

                    initTooltipped();

                    const tpicker = document.querySelector(".timepicker");

                    const { atHour, atMinute } = await run({
                        funcName: "getDailyClearConfig",
                    });

                    const time = buildTime({
                        hours: atHour,
                        minutes: atMinute,
                    });

                    tpicker.value = time;

                    const initialized = new M.Timepicker(tpicker, {
                        defaultTime: time,
                        twelveHour: false,
                        showClearBtn: true,
                        onCloseEnd: async () => {
                            const { time } = initialized;

                            if (!time) return;

                            show(preloader, hideCls);

                            const [hour, minute] = time.split(":");

                            if (+hour === atHour && +minute === atMinute)
                                return;

                            const status = await run({
                                funcName: "rescheduleClearTrigger",
                                params: [
                                    {
                                        atHour: +hour,
                                        atMinute: +minute,
                                    },
                                ],
                                onSuccess: () =>
                                    notify("Updated trigger!", primBckg),
                                onFailure: () =>
                                    notify(
                                        "Failed to update trigger!",
                                        failureBckg
                                    ),
                                onEnd: () => hide(preloader, hideCls),
                            });
                        },
                    });

                    const clearNow = document.getElementById("clearNow");
                    clearNow.addEventListener("click", async () => {
                        show(preloader, hideCls);

                        await run({
                            funcName: "handleDailyClear",
                            onEnd: () => hide(preloader, hideCls),
                            onSuccess: () => notify("Cleared!", primBckg),
                            onFailure: () =>
                                notify("Failed to clear!", failureBckg),
                        });
                    });

                    const {
                        triggers: { enableDailyClear, enableEditTrigger },
                        accounts: { ads = "", analytics = "" },
                    } = await gscript("getSettings");

                    const clear = document.getElementById("clear");
                    const edit = document.getElementById("edit");

                    clear.checked = enableDailyClear;
                    edit.checked = enableEditTrigger;

                    const updateSettings = async (update) => {
                        show(preloader, hideCls);

                        await run({
                            funcName: "updateSettings",
                            params: [update],
                            onEnd: () => hide(preloader, hideCls),
                            onSuccess: () =>
                                notify("Updated settings", primBckg),
                            onFailure: () =>
                                notify("Failed to update", failureBckg),
                        });
                    };

                    clear.addEventListener("change", () =>
                        updateSettings({
                            "triggers/enableDailyClear": clear.checked,
                        })
                    );

                    edit.addEventListener("change", () =>
                        updateSettings({
                            "triggers/enableEditTrigger": edit.checked,
                        })
                    );

                    const gaInput = document.getElementById("gaid");
                    // const adsSel = document.getElementById("adsid");

                    gaInput.value = analytics;

                    M.updateTextFields();

                    // const options = await getAdsAccounts(
                    //     ({ id, descriptiveName }) => [id, descriptiveName]
                    // );

                    // addOptions(adsSel, options);
                    // M.FormSelect.getInstance(adsSel).destroy();
                    // adsSel.value = ads; //TODO: change
                    // const inst = M.FormSelect.init(adsSel);

                    document.addEventListener(
                        "change",
                        async ({ target, currentTarget }) => {
                            if (target === currentTarget) return;

                            const { id } = target;

                            const handlerMap = {
                                gaid: {
                                    action: ({ value }) =>
                                        Promise.all([
                                            gscript("setProfileID", value),
                                            gscript("updateSettings", {
                                                "accounts/analytics": value,
                                            }),
                                        ]),
                                },
                                // adsid: {
                                //     action: ({ value }) =>
                                //         gscript("updateSettings", {
                                //             "accounts/ads": value,
                                //         }),
                                //     onSuccess: () =>
                                //         notify(`Ads Account updated`, primBckg),
                                //     onFailure: () =>
                                //         notify(
                                //             `Failed to update Ads Account`,
                                //             failureBckg
                                //         ),
                                // },
                            };

                            const { action, onSuccess, onFailure } =
                                handlerMap[id];

                            try {
                                show(preloader, hideCls);

                                const status = await action(target);

                                notify(
                                    status
                                        ? `Analytics Id updated`
                                        : `Failed to update Analytics Id`,
                                    status ? primBckg : failureBckg
                                );
                            } catch ({ message }) {
                                await gscript("logException", "save", message);
                            } finally {
                                hide(preloader, hideCls);
                            }
                        }
                    );

                    const reset = document.getElementById("reset");

                    reset.addEventListener("click", async () => {
                        try {
                            show(preloader, hideCls);
                            disable(reset);

                            const { status, errors } = await gscript("reset");
                            gaInput.value = "";
                            tpicker.value = buildTime();
                            clear.checked = true;
                            edit.checked = true;

                            if (status)
                                return notify(`Reset succeeded`, primBckg);

                            errors.forEach((err) => notify(err, failureBckg));
                        } catch ({ message }) {
                            await gscript("logException", "reset", message);
                        } finally {
                            hide(preloader, hideCls);
                            enable(reset);
                        }
                    });

                    hide(preloader, hideCls);
                });
            })();
        </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
    </body>
</html>
