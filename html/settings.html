<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Settings</title>

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Icons"
        />

        <?!= style ?>
    </head>

    <body>
        <header>
            <div class="nav-wrapper valign-wrapper col s12 light-blue darken-3">
                <div class="container">
                    <h5 class="white-text">Settings</h5>
                </div>
            </div>
            <div class="preload-wrapper">
                <div id="preload" class="progress light-blue darken-3">
                    <div class="indeterminate white"></div>
                </div>
            </div>
        </header>

        <main>
            <div class="container">
                <div class="row dense">
                    <div class="col s12">
                        <div class="input-field">
                            <input
                                id="clearAt"
                                name="clearAt"
                                placeholder="00:00"
                                type="text"
                                class="timepicker tooltipped"
                                data-position="bottom"
                                data-tooltip="Time when the sheet is cleared"
                            />
                            <label for="clearAt">Clear At</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s4">
                        <a
                            id="clearNow"
                            class="waves-effect light-blue darken-3 btn"
                            >Clear Now</a
                        >
                    </div>
                    <div class="col s4">
                        <a
                            id="formatNow"
                            class="waves-effect light-blue darken-3 btn"
                            >Format Now</a
                        >
                    </div>
                </div>
                <div class="row valign-wrapper">
                    <div class="col s10">
                        <p class="dense" for="clear">Discard data daily</p>
                    </div>
                    <div class="col s2">
                        <div class="switch">
                            <label>
                                <input
                                    id="clear"
                                    name="enableDailyClear"
                                    type="checkbox"
                                />
                                <span class="lever right"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row valign-wrapper">
                    <div class="col s10">
                        <p class="dense" for="edit">Enable edit trigger</p>
                    </div>
                    <div class="col s2">
                        <div class="switch">
                            <label>
                                <input
                                    id="edit"
                                    name="enableEditTrigger"
                                    type="checkbox"
                                />
                                <span class="lever right"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <select id="account" name="account">
                            <option value="" disabled selected>Select</option>
                        </select>
                        <label for="account">Analytics Account</label>
                    </div>

                    <div class="input-field col s12">
                        <select id="property" name="property">
                            <option value="" disabled selected>Select</option>
                        </select>
                        <label for="property">Analytics Property</label>
                    </div>

                    <div class="input-field col s12">
                        <select id="profile" name="profile">
                            <option value="" disabled selected>Select</option>
                        </select>
                        <label for="profile">Analytics Profile</label>
                    </div>
                    <!-- <div class="input-field col s12">
            <select id="adsid">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Google Ads Account</label>
          </div> -->
                </div>
                <div class="row">
                    <div class="col s12">
                        <a
                            id="reset"
                            class="waves-effect light-blue darken-3 btn"
                            >Reset</a
                        >
                    </div>
                </div>
            </div>
        </main>

        <?!= run ?>
        <?!= utils ?>
        <?!= common ?>

        <script>
            ((_w, d) => {
                const primBckg = "primary-background";
                const failureBckg = "failure-background";
                const hideCls = "hidden";

                const initTooltipped = (options = {}) => {
                    const elems = document.querySelectorAll(".tooltipped");
                    return M.Tooltip.init(elems, options);
                };

                window.addEventListener(
                    "error",
                    async (/** @type {ErrorEvent} */ ev) => {
                        const { message = "unknown error" } = ev;

                        await gscript("logException", "settings", message);

                        notify("Something went wrong!", failureBckg);
                    }
                );

                window.addEventListener(
                    "unhandledrejection",
                    async (/** @type {PromiseRejectionEvent} */ ev) => {
                        const {
                            reason: {
                                name = "Error",
                                message = "unknown rejection",
                            },
                        } = ev;

                        await gscript(
                            "logException",
                            "settings",
                            `${name} | ${message}`
                        );

                        notify("Something went wrong!", failureBckg);
                    }
                );

                window.addEventListener("DOMContentLoaded", async (ev) => {
                    M.AutoInit();

                    await gscript(
                        "sendPageview",
                        getCid(),
                        "{{page_url}}",
                        "{{page_title}}",
                        "{{page_path}}"
                    );

                    const preloader = document.querySelector("#preload");

                    initTooltipped();

                    const tpicker = document.querySelector(".timepicker");

                    const { atHour, atMinute } = await run({
                        funcName: "getDailyClearConfig",
                    });

                    const time = buildTime({
                        hours: atHour,
                        minutes: atMinute,
                    });

                    tpicker.value = time;

                    const initialized = new M.Timepicker(tpicker, {
                        defaultTime: time,
                        twelveHour: false,
                        showClearBtn: true,
                        onCloseEnd: async () => {
                            const { time } = initialized;

                            if (!time) return;

                            show(preloader, hideCls);

                            const [hour, minute] = time.split(":");

                            if (+hour === atHour && +minute === atMinute)
                                return;

                            const status = await run({
                                funcName: "rescheduleClearTrigger",
                                params: [
                                    {
                                        atHour: +hour,
                                        atMinute: +minute,
                                    },
                                ],
                                onSuccess: () =>
                                    notify("Updated trigger!", primBckg),
                                onFailure: () =>
                                    notify(
                                        "Failed to update trigger!",
                                        failureBckg
                                    ),
                                onEnd: () => hide(preloader, hideCls),
                            });
                        },
                    });

                    const clearNow = document.getElementById("clearNow");
                    clearNow.addEventListener("click", async () => {
                        try {
                            await gscript("handleDailyClear");
                            notify("Cleared!", primBckg);
                        } catch (error) {
                            notify("Failed to clear!", failureBckg);
                        } finally {
                            hide(preloader, hideCls);
                        }
                    });

                    const formatNow = document.getElementById("formatNow");
                    formatNow.addEventListener("click", async () => {
                        try {
                            show(preloader, hideCls);
                            await gscript("formatFormSheet");
                            notify("Formatted!", primBckg);
                        } catch (error) {
                            notify("Failed to format!", failureBckg);
                        } finally {
                            hide(preloader, hideCls);
                        }
                    });

                    const settings = await gscript("getSettings");

                    const {
                        triggers: { enableDailyClear, enableEditTrigger },
                        accounts: { /* ads = "", */ analytics },
                    } = settings;

                    const clear = document.getElementById("clear");
                    const edit = document.getElementById("edit");

                    clear.checked = enableDailyClear;
                    edit.checked = enableEditTrigger;

                    await setupAnalytics(analytics);

                    M.updateTextFields();

                    // const adsSel = document.getElementById("adsid");
                    // const options = await getAdsAccounts(
                    //     ({ id, descriptiveName }) => [id, descriptiveName]
                    // );

                    // addOptions(adsSel, options);
                    // M.FormSelect.getInstance(adsSel).destroy();
                    // adsSel.value = ads; //TODO: change
                    // const inst = M.FormSelect.init(adsSel);

                    document.addEventListener(
                        "change",
                        async ({ target, currentTarget }) => {
                            if (target === currentTarget) return;

                            const { id } = target;

                            const handlerMap = {
                                clear: ({ checked }) =>
                                    gscript("updateSettings", {
                                        "triggers/enableDailyClear": checked,
                                    }),
                                edit: ({ checked }) =>
                                    gscript("updateSettings", {
                                        "triggers/enableEditTrigger": checked,
                                    }),
                                // adsid: {
                                //     action: ({ value }) =>
                                //         gscript("updateSettings", {
                                //             "accounts/ads": value,
                                //         })
                                // },
                            };

                            const action = handlerMap[id];

                            try {
                                show(preloader, hideCls);

                                const status = await action(target);

                                notify(
                                    status
                                        ? `Settings updated`
                                        : `Failed to update`,
                                    status ? primBckg : failureBckg
                                );
                            } catch ({ message }) {
                                await gscript("logException", "save", message);
                            } finally {
                                hide(preloader, hideCls);
                            }
                        }
                    );

                    const reset = d.getElementById("reset");

                    reset.addEventListener("click", async () => {
                        try {
                            show(preloader, hideCls);
                            disable(reset);

                            const { status, errors } = await gscript("reset");

                            reinitSelect(d.getElementById("account"));
                            reinitSelect(d.getElementById("property"));
                            reinitSelect(d.getElementById("profile"));

                            tpicker.value = buildTime();
                            clear.checked = true;
                            edit.checked = true;

                            if (status)
                                return notify(`Reset succeeded`, primBckg);

                            errors.forEach((err) => notify(err, failureBckg));
                        } catch ({ message }) {
                            await gscript("logException", "reset", message);
                        } finally {
                            hide(preloader, hideCls);
                            enable(reset);
                        }
                    });

                    hide(preloader, hideCls);
                });
            })(window, document);
        </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
    </body>
</html>
