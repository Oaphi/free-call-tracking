<script type="text/javascript" defer>
  (() => {
    M.AutoInit();

    const handlerMap = {
      yes: {
        action: () => gscript("installGAtag"),
        onSuccess: () => notify("Successfully installed tag"),
        onFailure: () => notify("Failed to install tag"),
        onError: () => notify("Something went wrong during install"),
      },
      no: {
        action: () => gscript("setGaInstallDismissed"),
        onSuccess: close,
        onFailure: () => {}, //noop
        onError: () =>
          notify(
            `Failed to save (you will be prompted again if no UA tag is found)`
          ),
      },
    };

    const ids = Object.keys(handlerMap);

    document.addEventListener("click", async ({ target }) => {
      const { id } = target;

      if (!ids.includes(id)) return;

      const { action, onSuccess, onFailure, onError } = handlerMap[id];

      const preload = document.querySelector("#preload");

      try {
        show(preload);

        ids.forEach(disable);

        const status = await action();

        status ? onSuccess() : onFailure();
      } catch ({ message }) {
        await gscript("logException", "settings", message);
        onError(message);
      } finally {
        hide(preload);
        ids.forEach(enable);
      }
    });
  })();
</script>
