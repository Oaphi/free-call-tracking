<script>
    ((w, d) => {
        const enableActions = () => {
            const actionWrap = d.getElementById("actions");
            const actions = [...actionWrap.querySelectorAll("a.btn")];
            actions.forEach(({ classList }) => classList.remove("disabled"));
        };

        /**
         * @summary check if can enable actions
         * @param {HTMLSelectElement} accSel
         * @param {HTMLSelectElement} contSel
         * @param {HTMLSelectElement} wsapceSel
         * @returns {boolean}
         */
        const checkSettings = (accSel, contSel, wspaceSel) =>
            [accSel, contSel, wspaceSel].every(({ value }) => !!value);

        d.addEventListener("click", async ({ target }) => {
            const idMap = {
                deploy: async () => {
                    await gscript("updateSettings", { firstTime: false });
                    await gscript("deployAddonGo");
                    google.script.host.close();
                },
            };

            const handler = idMap[/** @type {Element} */ (target).id];
            if (!handler) return;

            await handler();
        });

        w.addEventListener("load", async () => {
            const preload = d.getElementById("preload");

            w.addEventListener("error", async ({ message, srcElement }) => {
                hide(preload, "hidden");
                await gscript("logException", "FTE", message);
            });

            w.addEventListener(
                "unhandledrejection",
                async ({ reason, promise }) => {
                    hide(preload, "hidden");
                    console.debug(reason);
                }
            );

            M.AutoInit();

            show(preload, "hidden");
            const accounts = await gscript("listTagManagerAccounts");
            const accOpts = accounts.map(({ accountId, name }) => [
                accountId,
                name,
            ]);
            hide(preload, "hidden");

            const accSel = d.getElementById("Acc");
            const contSel = d.getElementById("Cont");
            const workSel = d.getElementById("Work");

            addOptions(accSel, accOpts);
            M.FormSelect.init(accSel);

            accSel.addEventListener("change", async ({ target }) => {
                const { value } = /** @type {HTMLSelectElement} */ (target);

                show(preload, "hidden");
                const containers = await gscript(
                    "getConteinersArrByAcc",
                    `accounts/${value}`
                );

                const contOpts = containers.map(({ containerId, name }) => [
                    containerId,
                    name,
                ]);

                addOptions(contSel, contOpts);
                M.FormSelect.init(contSel);
                hide(preload, "hidden");

                checkSettings(accSel, contSel, workSel) && enableActions();
            });

            contSel.addEventListener("change", async ({ target }) => {
                const { value } = /** @type {HTMLSelectElement} */ (target);

                show(preload, "hidden");
                const wspaces = await gscript(
                    "getWorkspacesArrByCont",
                    `accounts/${accSel.value}/containers/${value}`
                );

                const wspaceOpts = wspaces.map(({ workspaceId, name }) => [
                    workspaceId,
                    name,
                ]);

                addOptions(workSel, wspaceOpts);
                M.FormSelect.init(workSel);
                hide(preload, "hidden");

                checkSettings(accSel, contSel, workSel) && enableActions();
            });

            workSel.addEventListener("change", () => {
                checkSettings(accSel, contSel, workSel) && enableActions();
            });

            const cleanBtn = d.getElementById("clean");
            cleanBtn.addEventListener("click", async () => {
                show(preload, "hidden");

                const ids = [accSel, contSel, workSel].map(
                    ({ value }) => value
                );

                const regex =
                    /(?:caller on site|window loaded|cid|getClientId|getTime)[\w-]+/i;

                const status = await gscript(
                    "cleanupOldVersion",
                    ...ids,
                    regex.source,
                    regex.flags
                );

                notify(
                    status ? "Finished cleaning up" : "Failed to clean up",
                    status ? "primary-background" : "failure-background"
                );

                hide(preload, "hidden");
            });
        });
    })(window, document);
</script>
