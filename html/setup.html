<html>
  <head>
    <base target="_blank" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Please select your Account</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <style>
      :root {
        --analytics-color: #e3f2fd;
        --gtm-color: #f9fbe7;
        --ads-color: #ffebee;
        --error-color: #f44336;
        --underline-color: #9e9e9e;
      }

      #toast-container {
        bottom: auto !important;
        left: auto !important;
        top: 20%;
        right: 10%;
      }

      #toast-container .toast {
        cursor: pointer;
      }

      #toast-container .toast::after {
        font-family: "Material Icons";
        content: "close";
        color: var(--error-color);
        font-size: 1.5rem;
        font-weight: 300;
        float: right;
        padding-left: 3rem;
      }

      .toast-error {
        background-color: var(--error-color);
      }

      .notice {
        width: 100%;
        margin: auto;
      }

      .removed {
        display: none;
      }

      /* TODO: make independent of Google Ads */
      .ads-color[type="checkbox"].filled-in:checked + span:not(.lever):after {
        border: 2px solid var(--underline-color);
        background-color: var(--underline-color);
      }
    </style>
  </head>

  <body>
    <form
      class="main"
      id="form"
      novalidate="novalidate"
      style="max-width: 580px; margin: 20px auto"
    >
      <!----------------------------------------------- Analytics  -------------------------------------------------------->
      <div class="#e3f2fd blue lighten-5">
        <div class="row">
          <div class="input-field col s12">
            <select id="GaAcc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrGaAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrGaAccs[r].id ?>"><?= ArrGaAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Analytics account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Prop" name="Prop">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select your Google Analytics property</label>
          </div>
        </div>
      </div>

      <!----------------------------------------------- Tag Manager  -------------------------------------------------------->
      <div class="#f9fbe7 lime lighten-5">
        <div class="row">
          <div class="input-field col s12">
            <select id="Acc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrAccs[r].path ?>"><?= ArrAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Tag Manager account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Cont" name="Cont">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Google Tag Manager container</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Work" name="Work">
              <option value="" disabled selected>Select</option>
            </select>
            <label
              >Select Google Tag Manager workspace (* Default workspace is
              recommended)</label
            >
          </div>
        </div>
      </div>

      <!-- Google Ads -->
      <div class="row">
        <div class="col s12">
          <label>
            <input
              id="gAdsSwitch"
              name="gAdsSwitch"
              class="filled-in ads-color"
              type="checkbox"
              checked="checked"
            />
            <span>Connect a Google Ads Account</span>
          </label>
        </div>
      </div>
      <div id="gAdsSetup" class="#ffebee red lighten-5">
        <div class="row">
          <div class="input-field col s12">
            <select id="Ads" name="Ads">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Google Ads Account</label>
          </div>
        </div>
      </div>
      <!-- end Google Ads -->

      <div class="row" id="Preloader1">
        <a> Please wait ... </a>
        <div class="progress" id="Preloader" name="Preloader">
          <div class="indeterminate"></div>
        </div>
      </div>

      <div class="row" id="saveme">
        <div class="input-field col s2">
          <input placeholder="Call" id="MyCategory" type="text" />
          <label for="MyCategory">Category</label>
        </div>

        <div class="input-field col s2">
          <input placeholder="Call" id="MyEvent" type="text" />
          <label for="MyEvent">Event</label>
        </div>

        <div class="input-field col s3">
          <button
            class="waves-effect waves-light btn blue"
            type="button"
            onclick="submitForm()"
          >
            <i class="material-icons left">check</i>Deploy
          </button>
        </div>
        <div class="input-field col s3">
          <button
            class="waves-effect waves-light btn red"
            type="button"
            onclick="google.script.host.close()"
          >
            <i class="material-icons left">cancel</i>Cancel
          </button>
        </div>
      </div>
    </form>

    <?!= run ?>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      function removeOptions(selectElement) {
        for (var i = selectElement.options.length - 1; i > 0; i--)
          selectElement.remove(i);
      }

      function resetSelectPropagation() {
        document
          .querySelectorAll(".select-wrapper")
          .forEach((t) =>
            t.addEventListener("click", (e) => e.stopPropagation())
          );
      }

      $(() => {
        $("#Preloader1").hide();

        M.AutoInit();

        //map of selector : handler
        const changeHandlers = {
          "#gAdsSwitch": changeAdsFormVisibility,
          "#GaAcc": formChangeGaAccount,
          "#Acc": formChangeAccount,
          "#Cont": formChangeContainer,
        };

        const $doc = $(document);

        Object.entries(changeHandlers).forEach(([selector, handler]) =>
          $doc.on("change", selector, handler)
        );

        resetSelectPropagation();
      });

      function changeAdsFormVisibility(/** @type {Event} */ event) {
        const {
          target: { checked },
        } = event;

        const adsForm = $("#gAdsSetup"),
          duration = 100;

        checked ? adsForm.show(duration) : adsForm.hide(duration);
      }

      async function getAdsAccounts() {
        await run({
          funcName: "",
        });
      }

      async function formChangeGaAccount() {
        var sAccId = $("#GaAcc").val();
        if (sAccId) {
          $("#Preloader1").show();

          const { status, properties } = await run({
            funcName: "getGaPropertiesArrByAcc",
            params: [sAccId],
            onFailure: (err) => {
              $("#GaAcc").find("option:first").prop("selected", true);

              $("#GaAcc").formSelect();

              resetSelectPropagation();

              showErrorMsg(err);
            },
          });

          if (!status) {
            return M.toast(
              `Failed to load Analytics properties!`,
              5e2,
              "toast-error"
            );
          }

          function refreshContainers(data) {
            $("#Preloader1").hide();
            var Arr = data;
            var Opt = document.getElementById("Prop");
            removeOptions(Opt);

            for (var r = 0; r < Arr.length; r++) {
              addOption(Opt, Arr[r].name, Arr[r].id);
            }
            $("#Prop").formSelect();
            resetSelectPropagation();
          }

          refreshContainers(properties);
        }
      }

      const handleChange = (/** @type {string} */ id) => (data) => {
        $("#Preloader1").hide();

        const sel = document.getElementById(id);
        removeOptions(sel);

        const { length } = data;

        data.forEach(({ name, path }) => addOption(sel, name, path));

        $(sel).formSelect();

        resetSelectPropagation();
      };

      function formChangeAccount() {
        var sAccPath = $("#Acc").val();
        if (sAccPath) {
          $("#Preloader1").show();
          google.script.run
            .withFailureHandler((err) => {
              $("#Acc").find("option:first").prop("selected", true);

              $("#Acc").formSelect();

              resetSelectPropagation();

              showErrorMsg(err);
            })
            .withSuccessHandler(handleChange("Cont"))
            .getConteinersArrByAcc(sAccPath);
        }
      }

      function formChangeContainer() {
        var sContPath = $("#Cont").val();
        if (sContPath) {
          $("#Preloader1").show();
          google.script.run
            .withFailureHandler((err) => {
              $("#Cont").find("option:first").prop("selected", true);

              $("#Cont").formSelect();

              resetSelectPropagation();

              showErrorMsg(err);
            })
            .withSuccessHandler(handleChange("Work"))
            .getWorkspacesArrByCont(sContPath);
        }
      }

      function addOption(oListbox, text, value) {
        var oOption = document.createElement("option");
        oOption.appendChild(document.createTextNode(text));
        oOption.setAttribute("value", value);
        oListbox.appendChild(oOption);
      }

      async function submitForm() {
        var sGaAcc = $("#GaAcc").val();
        var sProfileId = $("#Prop").val();
        var sAccValue = $("#Acc").val();
        var sContValue = $("#Cont").val();
        var sWorkValue = $("#Work").val();

        var sMyCategory = $("#MyCategory").val() || "Call";
        var sMyEvent = $("#MyEvent").val() || "Call";

        var issues = [];

        if (!sGaAcc) issues.push("Please select an Analytics Account!");
        if (!sProfileId) issues.push("Please select an Analytics Property!");
        if (!sAccValue) issues.push("Please select a Tag Manager Account!");
        if (!sContValue) issues.push("Please select a Container!");
        if (!sWorkValue) issues.push("Please select a Workspace!");

        if (issues.length) return issues.forEach((msg) => M.toast(msg, 4000));

        $("#Preloader1").show();

        await run({
          funcName: "deployAddon",
          params: [
            sProfileId,
            sContValue,
            sWorkValue,
            sMyCategory,
            sMyEvent,
            sAccValue,
          ],
          onSuccess: closeForm,
          onFailure: showErrorMsg,
        });
      }

      function showErrorMsg(err) {
        $("#Preloader1").hide();

        M.toast(
          'Received error:<br>"' +
            err.message +
            '"<br>This is an unexpected behavior. We are already fixing this.',
          10000,
          "toast-error"
        );
      }

      function closeForm() {
        google.script.host.close();
      }

      /**
       * @see https://github.com/Dogfalo/materialize/issues/1453
       */
      $(document).on("click", "#toast-container .toast", function () {
        $(this).fadeOut(function () {
          $(this).first()[0].M_Toast.remove();
        });
      });
    </script>
  </body>
</html>
