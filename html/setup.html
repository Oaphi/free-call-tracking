<html>
  <head>
    <base target="_blank" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Please select your Account</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <?!= setupStyle ?>
    <?!= style ?>
  </head>

  <body class="hidden">
    <div class="preload-wrapper">
      <div id="Preloader1" class="progress light-blue darken-3 hidden">
        <div class="indeterminate white"></div>
      </div>
    </div>

    <form class="main" id="form" novalidate="novalidate">
      <div class="section">
        <div class="row">
          <div class="input-field col s12">
            <select id="GaAcc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrGaAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrGaAccs[r].id ?>"><?= ArrGaAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Analytics account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Prop" name="Prop">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select your Google Analytics property</label>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="input-field col s12">
            <select id="Acc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrAccs[r].path ?>"><?= ArrAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Tag Manager account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Cont" name="Cont">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Google Tag Manager container</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Work" name="Work">
              <option value="" disabled selected>Select</option>
            </select>
            <label class="multiline"
              >Select Google Tag Manager workspace<br />
              * Default is recommended</label
            >
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col s12">
          <label>
            <input
              id="gAdsSwitch"
              name="gAdsSwitch"
              class="filled-in ads-color"
              type="checkbox"
              checked="checked"
            />
            <span>Send conversions to Google Ads</span>
          </label>
        </div>
      </div>

      <div id="gAdsSetup" class="section">
        <div class="row">
          <div class="input-field col s12">
            <select id="Ads" name="Ads">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Ads Account</label>
          </div>
        </div>
      </div>

      <div class="row" id="saveme">
        <div class="input-field col s6 m2">
          <input placeholder="Call" id="MyCategory" type="text" />
          <label for="MyCategory">Category</label>
        </div>

        <div class="input-field col s6 m2">
          <input placeholder="Call" id="MyEvent" type="text" />
          <label for="MyEvent">Event</label>
        </div>

        <div class="input-field col s6 m3">
          <button
            id="submit"
            class="waves-effect waves-theme btn primary-background"
            type="button"
          >
            <i class="material-icons left">check</i>Deploy
          </button>
        </div>
        <div class="input-field col s6 m3">
          <button
            id="cancel"
            class="waves-effect waves-theme btn neutral-background"
            type="button"
          >
            <i class="material-icons left">cancel</i>Cancel
          </button>
        </div>
      </div>
    </form>

    <?!= run ?>
    <?!= utils ?>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      (() => {
        const config = {
          classes: {
            notify: {
              error: "toast-error",
            },
          },
          ids: {
            preloader: "#Preloader1",
          },
        };

        const showLoader = () => $(config.ids.preloader).removeClass("hidden");

        const hideLoader = () => $(config.ids.preloader).addClass("hidden");

        /**
         * @param {string} text
         * @param {string} value
         */
        const addOption = (text, value) => {
          const opt = document.createElement("option");
          opt.appendChild(document.createTextNode(text));
          opt.setAttribute("value", value);
          return opt;
        };

        /**
         * @param {HTMLSelectElement} selectElement
         */
        const removeOptions = (selectElement) => {
          const {
            options: { length },
            options,
          } = selectElement;

          for (const opt of options) opt.remove();
        };

        function resetSelectPropagation() {
          $(document).click((event) => {
            const { target, currentTarget } = event;
            if (target === currentTarget) return;
            if (target.matches(".select-wrapper")) event.stopPropagation();
          });
        }

        $(async () => {
          M.AutoInit();

          //map of selector : handler
          const changeHandlers = {
            gAdsSwitch: changeAdsFormVisibility,
            GaAcc: formChangeGaAccount,
            Acc: formChangeAccount,
            Cont: formChangeContainer,
          };

          const $doc = $(document);

          Object.entries(changeHandlers).forEach(([id, handler]) =>
            $doc.on("change", `#${id}`, handler)
          );

          resetSelectPropagation();

          $("body").removeClass("hidden");

          showLoader();

          const customers = await getAdsAccounts(({ id, descriptiveName }) => ({
            name: descriptiveName,
            id,
          }));

          handleChange("Ads", "id")(customers);

          $("#submit").click(debounce(deployAddon));

          $("#cancel").click(closeForm);

          hideLoader();
        });

        /**
         * @param {string} msg
         * @param {number} duration
         * @param {...string} classes
         */
        const notify = (msg, duration, ...classes) =>
          M.toast({
            html: msg,
            classes: classes.join(" "),
            displayLength: duration,
          });

        /**
         * @param {Event} event
         */
        const changeAdsFormVisibility = (event) => {
          const {
            target: { checked },
          } = event;

          const adsForm = $("#gAdsSetup"),
            duration = 100;

          checked ? adsForm.show(duration) : adsForm.hide(duration);
        };

        /**
         * @param {string} id
         * @param {string} prop
         */
        const handleChange = (id, prop) => (data) => {
          hideLoader();

          const sel = document.getElementById(id);
          removeOptions(sel);

          const { length } = data;

          data.unshift({ name: "Select", path: "" });

          const options = data.map((item) => addOption(item.name, item[prop]));

          sel.append(...options);

          $(sel).formSelect();
        };

        /**
         * @param {string} selId
         */
        const handleChangeFailure = (selId) => (err) => {
          $(`#${selId}`).find("option:first").prop("selected", true);

          $(`#${selId}`).formSelect();

          showError(err);
        };

        const formChangeGaAccount = async () => {
          const selId = "#GaAcc";

          const sAccId = $(selId).val();
          if (!sAccId) return;
          showLoader();

          const { status, properties } = await run({
            funcName: "getGaPropertiesArrByAcc",
            params: [sAccId],
            onFailure: handleChangeFailure(selId),
          });

          if (!status) return showError(`Failed to load Analytics properties!`);

          handleChange("Prop", "id")(properties);
        };

        /**
         * @param {string} selId
         * @param {string} subSelId
         * @param {string} prop
         * @param {string} handlerName
         */
        const getEntities = (selId, subSelId, prop, handlerName) => {
          const sAccPath = $(`#${selId}`).val();

          if (!sAccPath) return;

          showLoader();

          google.script.run
            .withFailureHandler(handleChangeFailure(selId))
            .withSuccessHandler(handleChange(subSelId, prop))
            [handlerName](sAccPath);
        };

        const formChangeAccount = () =>
          getEntities("Acc", "Cont", "path", "getConteinersArrByAcc");

        const formChangeContainer = () =>
          getEntities("Cont", "Work", "path", "getWorkspacesArrByCont");

        async function deployAddon() {
          const [
            gaAccount,
            gaAccountId,
            gtmAccountPath,
            gtmContainerPath,
            gtmWorkspacePath,
            adsAccount,
          ] = $("#GaAcc, #Prop, #Acc, #Cont, #Work, #Ads").map((i, el) =>
            $(el).val()
          );

          console.debug(adsAccount, $("#Ads"));

          const willLinkAds = $("#gAdsSwitch").is(":checked");

          const issues = [];

          if (!gaAccount) issues.push("Please select an Analytics Account!");
          if (!gaAccountId) issues.push("Please select an Analytics Property!");
          if (!gtmAccountPath)
            issues.push("Please select a Tag Manager Account!");
          if (!gtmContainerPath) issues.push("Please select a Container!");
          if (!gtmWorkspacePath) issues.push("Please select a Workspace!");
          if (willLinkAds && !adsAccount)
            issues.push("Please select an Ads Account");

          const { error } = config.classes.notify;

          if (issues.length)
            return issues.forEach((msg) => notify(msg, 4e3, error));

          showLoader();
          disable("submit");

          if (willLinkAds) {
            await run({
              funcName: "linkAllAccounts",
              onFailure: () =>
                showError(`Failed to link your Ads accounts!`, 4e3),
              onSuccess: ({ length }) => {
                notify(
                  `Linked ${length} Ads account${length === 1 ? "" : "s"}`,
                  4e3
                );
              },
            });
          }

          const gaCategory = $("#MyCategory").val() || "Call";
          const gaEvent = $("#MyEvent").val() || "Call";

          await run({
            funcName: "deployAddon",
            params: [
              {
                gaAccountId,
                gtmContainerPath,
                gtmWorkspacePath,
                gtmAccountPath,
                gaCategory,
                gaEvent,
              },
              adsAccount,
            ],
            onSuccess: closeForm,
            onFailure: showError,
            onEnd: () => enable("submit"),
          });
        }

        /**
         * @param {Error|string} error
         */
        const showError = async (error, duration = 1e4) => {
          hideLoader();

          notify(
            error || `This is unexpected! We are fixing this`,
            duration,
            config.classes.notify.error
          );
        };

        const closeForm = () => google.script.host.close();

        $(document).on("click", ".toast", ({ target }) => {
          M.Toast.getInstance(target).dismiss();
        });
      })();
    </script>
  </body>
</html>
