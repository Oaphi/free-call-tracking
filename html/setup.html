<html>
  <head>
    <base target="_blank" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Please select your Account</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <style>
      :root {
        --analytics-color: #e3f2fd;
        --gtm-color: #f9fbe7;
        --ads-color: #ffebee;
        --underline-color: #9e9e9e;
      }

      #toast-container {
        bottom: auto !important;
        left: auto !important;
        top: 20%;
      }

      #toast-container .toast {
        cursor: pointer;
      }

      #toast-container .toast::after {
        font-family: "Material Icons";
        content: "close";
        font-size: 1.5rem;
        font-weight: 300;
        float: right;
        padding-left: 3rem;
      }

      .toast-error {
        background-color: var(--theme-failure-color);
      }

      .removed {
        display: none;
      }

      .notice {
        width: 100%;
        margin: auto;
      }

      /* TODO: make independent of Google Ads */
      .ads-color[type="checkbox"].filled-in:checked + span:not(.lever):after {
        border: 2px solid var(--underline-color);
        background-color: var(--underline-color);
      }

      @media screen and (min-width: 300px) {
        .input-field {
          margin-bottom: 0;
        }
      }

      @media screen and (min-width: 600px) {
        .row {
          margin-bottom: 10px;
        }
      }
    </style>

    <?!= style ?>
  </head>

  <body class="hidden">
    <div class="preload-wrapper">
      <div id="Preloader1" class="progress light-blue darken-3 hidden">
        <div class="indeterminate light-blue"></div>
      </div>
    </div>

    <form class="main" id="form" novalidate="novalidate">
      <div class="section">
        <div class="row">
          <div class="input-field col s12">
            <select id="GaAcc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrGaAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrGaAccs[r].id ?>"><?= ArrGaAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Analytics account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Prop" name="Prop">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select your Google Analytics property</label>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="input-field col s12">
            <select id="Acc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrAccs[r].path ?>"><?= ArrAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Tag Manager account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Cont" name="Cont">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Google Tag Manager container</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Work" name="Work">
              <option value="" disabled selected>Select</option>
            </select>
            <label class="multiline"
              >Select Google Tag Manager workspace<br />
              * Default is recommended</label
            >
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col s12">
          <label>
            <input
              id="gAdsSwitch"
              name="gAdsSwitch"
              class="filled-in ads-color"
              type="checkbox"
              checked="checked"
            />
            <span>Send conversions to Google Ads</span>
          </label>
        </div>
      </div>

      <div id="gAdsSetup" class="section">
        <div class="row">
          <div class="input-field col s12">
            <select id="Ads" name="Ads">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Ads Account</label>
          </div>
        </div>
      </div>

      <div class="row" id="saveme">
        <div class="input-field col s6 m2">
          <input placeholder="Call" id="MyCategory" type="text" />
          <label for="MyCategory">Category</label>
        </div>

        <div class="input-field col s6 m2">
          <input placeholder="Call" id="MyEvent" type="text" />
          <label for="MyEvent">Event</label>
        </div>

        <div class="input-field col s6 m3">
          <button
            id="submit"
            class="waves-effect waves-theme btn primary-background"
            type="button"
          >
            <i class="material-icons left">check</i>Deploy
          </button>
        </div>
        <div class="input-field col s6 m3">
          <button
            id="cancel"
            class="waves-effect waves-theme btn neutral-background"
            type="button"
          >
            <i class="material-icons left">cancel</i>Cancel
          </button>
        </div>
      </div>
    </form>

    <?!= run ?>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      (() => {
        const config = {
          classes: {
            notify: {
              error: "toast-error",
            },
          },
          ids: {
            preloader: "#Preloader1",
          },
        };

        const disableBtn = (id) => $(`#${id}`).addClass("disabled");

        const enableBtn = (id) => $(`#${id}`).removeClass("disabled");

        const showLoader = () => $(config.ids.preloader).removeClass("hidden");

        const hideLoader = () => $(config.ids.preloader).addClass("hidden");

        /**
         * @param {string} text
         * @param {string} value
         */
        const addOption = (text, value) => {
          const opt = document.createElement("option");
          opt.appendChild(document.createTextNode(text));
          opt.setAttribute("value", value);
          return opt;
        };

        /**
         * @param {HTMLSelectElement} selectElement
         */
        const removeOptions = (selectElement) => {
          const {
            options: { length },
            options,
          } = selectElement;

          for (const opt of options) opt.remove();
        };

        function resetSelectPropagation() {
          $(document).click((event) => {
            const { target, currentTarget } = event;
            if (target === currentTarget) return;
            if (target.matches(".select-wrapper")) event.stopPropagation();
          });
        }

        $(async () => {
          M.AutoInit();

          //map of selector : handler
          const changeHandlers = {
            gAdsSwitch: changeAdsFormVisibility,
            GaAcc: formChangeGaAccount,
            Acc: formChangeAccount,
            Cont: formChangeContainer,
          };

          const $doc = $(document);

          Object.entries(changeHandlers).forEach(([id, handler]) =>
            $doc.on("change", `#${id}`, handler)
          );

          resetSelectPropagation();

          $("body").removeClass("hidden");

          showLoader();

          const customers = await getAdsAccounts();
          handleChange("Ads", "id")(customers);

          $("#submit").click(deployAddon);

          $("#cancel").click(closeForm);

          hideLoader();
        });

        /**
         * @param {string} msg
         * @param {number} duration
         * @param {...string} classes
         */
        const notify = (msg, duration, ...classes) =>
          M.toast({
            html: msg,
            classes: classes.join(" "),
            displayLength: duration,
          });

        /**
         * @param {Event} event
         */
        const changeAdsFormVisibility = (event) => {
          const {
            target: { checked },
          } = event;

          const adsForm = $("#gAdsSetup"),
            duration = 100;

          checked ? adsForm.show(duration) : adsForm.hide(duration);
        };

        const getAdsAccounts = async () => {
          try {
            const customers = await run({
              funcName: "getAllAccounts",
            });

            return customers.map(({ id, descriptiveName }) => ({
              name: descriptiveName,
              id,
            }));
          } catch (error) {
            console.warn(error);
            showError(`Failed to list Google Ads accounts!`, 4e3);
            return [];
          }
        };

        /**
         * @param {string} id
         * @param {string} prop
         */
        const handleChange = (id, prop) => (data) => {
          hideLoader();

          const sel = document.getElementById(id);
          removeOptions(sel);

          const { length } = data;

          data.unshift({ name: "Select", path: "" });

          const options = data.map((item) => addOption(item.name, item[prop]));

          sel.append(...options);

          $(sel).formSelect();
        };

        /**
         * @param {string} selId
         */
        const handleChangeFailure = (selId) => (err) => {
          $(`#${selId}`).find("option:first").prop("selected", true);

          $(`#${selId}`).formSelect();

          showError(err);
        };

        const formChangeGaAccount = async () => {
          const selId = "#GaAcc";

          const sAccId = $(selId).val();
          if (!sAccId) return;
          showLoader();

          const { status, properties } = await run({
            funcName: "getGaPropertiesArrByAcc",
            params: [sAccId],
            onFailure: handleChangeFailure(selId),
          });

          if (!status) return showError(`Failed to load Analytics properties!`);

          handleChange("Prop", "id")(properties);
        };

        /**
         * @param {string} selId
         * @param {string} subSelId
         * @param {string} prop
         * @param {string} handlerName
         */
        const getEntities = (selId, subSelId, prop, handlerName) => {
          const sAccPath = $(`#${selId}`).val();

          if (!sAccPath) return;

          showLoader();

          google.script.run
            .withFailureHandler(handleChangeFailure(selId))
            .withSuccessHandler(handleChange(subSelId, prop))
            [handlerName](sAccPath);
        };

        const formChangeAccount = () =>
          getEntities("Acc", "Cont", "path", "getConteinersArrByAcc");

        const formChangeContainer = () =>
          getEntities("Cont", "Work", "path", "getWorkspacesArrByCont");

        async function deployAddon() {
          const [gaAccount, profileId, gtmAccount, container, workspace] = $(
            "#GaAcc, #Prop, #Acc, #Cont, #Work"
          ).map((i, el) => $(el).val());

          const sMyCategory = $("#MyCategory").val() || "Call";
          const sMyEvent = $("#MyEvent").val() || "Call";

          const issues = [];

          if (!gaAccount) issues.push("Please select an Analytics Account!");
          if (!profileId) issues.push("Please select an Analytics Property!");
          if (!gtmAccount) issues.push("Please select a Tag Manager Account!");
          if (!container) issues.push("Please select a Container!");
          if (!workspace) issues.push("Please select a Workspace!");

          const { error } = config.classes.notify;

          if (issues.length)
            return issues.forEach((msg) => notify(msg, 4e3, error));

          showLoader();
          disableBtn("submit");

          if ($("#gAdsSwitch").is(":checked")) {
            await run({
              funcName: "linkAllAccounts",
              onFailure: () =>
                showError(`Failed to link your Ads accounts!`, 4e3),
              onSuccess: ({ length }) => {
                notify(
                  `Linked ${length} Ads account${length === 1 ? "" : "s"}`,
                  4e3
                );
              },
            });
          }

          await run({
            funcName: "deployAddon",
            params: [
              profileId,
              container,
              workspace,
              sMyCategory,
              sMyEvent,
              gtmAccount,
            ],
            onSuccess: closeForm,
            onFailure: showError,
            onEnd: () => enableBtn("submit"),
          });
        }

        /**
         * @param {Error|string} error
         */
        const showError = async (error, duration = 1e4) => {
          hideLoader();

          notify(
            error || `This is unexpected! We are fixing this`,
            duration,
            config.classes.notify.error
          );
        };

        const closeForm = () => google.script.host.close();

        $(document).on("click", "#toast-container .toast", ({ target }) => {
          $(this).fadeOut(() => M.Toast.getInstance(target).dismiss());
        });
      })();
    </script>
  </body>
</html>
