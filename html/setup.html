<html>
  <head>
    <base target="_blank" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Please select your Account</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <style>
      :root {
        --analytics-color: #e3f2fd;
        --gtm-color: #f9fbe7;
        --ads-color: #ffebee;
        --error-color: #f44336;
        --underline-color: #9e9e9e;
      }

      #toast-container {
        bottom: auto !important;
        left: auto !important;
        top: 20%;
      }

      #toast-container .toast {
        cursor: pointer;
      }

      #toast-container .toast::after {
        font-family: "Material Icons";
        content: "close";
        font-size: 1.5rem;
        font-weight: 300;
        float: right;
        padding-left: 3rem;
      }

      .toast-error {
        background-color: var(--error-color);
      }

      .notice {
        width: 100%;
        margin: auto;
      }

      .removed {
        display: none;
      }

      /* TODO: make independent of Google Ads */
      .ads-color[type="checkbox"].filled-in:checked + span:not(.lever):after {
        border: 2px solid var(--underline-color);
        background-color: var(--underline-color);
      }
    </style>
  </head>

  <body>
    <form
      class="main"
      id="form"
      novalidate="novalidate"
      style="max-width: 580px; margin: 20px auto"
    >
      <!----------------------------------------------- Analytics  -------------------------------------------------------->
      <div class="#e3f2fd blue lighten-5">
        <div class="row">
          <div class="input-field col s12">
            <select id="GaAcc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrGaAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrGaAccs[r].id ?>"><?= ArrGaAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Analytics account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Prop" name="Prop">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select your Google Analytics property</label>
          </div>
        </div>
      </div>

      <!----------------------------------------------- Tag Manager  -------------------------------------------------------->
      <div class="#f9fbe7 lime lighten-5">
        <div class="row">
          <div class="input-field col s12">
            <select id="Acc">
              <option value="" disabled selected>Select</option>
              <? for (var r = 0; r < ArrAccs.length; r++) { ?>
              <!-- prettier-ignore -->
              <option value="<?= ArrAccs[r].path ?>"><?= ArrAccs[r].name ?></option>
              <? } ?>
            </select>
            <label>Select Google Tag Manager account</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Cont" name="Cont">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Google Tag Manager container</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <select id="Work" name="Work">
              <option value="" disabled selected>Select</option>
            </select>
            <label
              >Select Google Tag Manager workspace (* Default workspace is
              recommended)</label
            >
          </div>
        </div>
      </div>

      <!-- Google Ads -->
      <div class="row">
        <div class="col s12">
          <label>
            <input
              id="gAdsSwitch"
              name="gAdsSwitch"
              class="filled-in ads-color"
              type="checkbox"
              checked="checked"
            />
            <span>Connect a Google Ads Account</span>
          </label>
        </div>
      </div>
      <div id="gAdsSetup" class="#ffebee red lighten-5">
        <div class="row">
          <div class="input-field col s12">
            <select id="Ads" name="Ads">
              <option value="" disabled selected>Select</option>
            </select>
            <label>Select Google Ads Account</label>
          </div>
        </div>
      </div>
      <!-- end Google Ads -->

      <div class="row" id="Preloader1">
        <a> Please wait ... </a>
        <div class="progress" id="Preloader" name="Preloader">
          <div class="indeterminate"></div>
        </div>
      </div>

      <div class="row" id="saveme">
        <div class="input-field col s6 m2">
          <input placeholder="Call" id="MyCategory" type="text" />
          <label for="MyCategory">Category</label>
        </div>

        <div class="input-field col s6 m2">
          <input placeholder="Call" id="MyEvent" type="text" />
          <label for="MyEvent">Event</label>
        </div>

        <div class="input-field col s6 m3">
          <button
            id="submit"
            class="waves-effect waves-light btn blue"
            type="button"
          >
            <i class="material-icons left">check</i>Deploy
          </button>
        </div>
        <div class="input-field col s6 m3">
          <button
            id="cancel"
            class="waves-effect waves-light btn red"
            type="button"
          >
            <i class="material-icons left">cancel</i>Cancel
          </button>
        </div>
      </div>
    </form>

    <?!= run ?>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      function removeOptions(selectElement) {
        for (var i = selectElement.options.length - 1; i > 0; i--)
          selectElement.remove(i);
      }

      function resetSelectPropagation() {
        document
          .querySelectorAll(".select-wrapper")
          .forEach((t) =>
            t.addEventListener("click", (e) => e.stopPropagation())
          );
      }

      const config = {
        classes: {
          notify: {
            error: "toast-error",
          },
        },
      };

      $(() => {
        $("#Preloader1").hide();

        M.AutoInit();

        //map of selector : handler
        const changeHandlers = {
          "#gAdsSwitch": changeAdsFormVisibility,
          "#GaAcc": formChangeGaAccount,
          "#Acc": formChangeAccount,
          "#Cont": formChangeContainer,
        };

        const $doc = $(document);

        Object.entries(changeHandlers).forEach(([selector, handler]) =>
          $doc.on("change", selector, handler)
        );

        resetSelectPropagation();

        $("#submit").click(submitForm);

        $("#cancel").click(closeForm);
      });

      /**
       * @param {string} msg
       * @param {number} duration
       * @param {...string} classes
       */
      const notify = (msg, duration, ...classes) =>
        M.toast({
          html: msg,
          classes: classes.join(" "),
          displayLength: duration,
        });

      function changeAdsFormVisibility(/** @type {Event} */ event) {
        const {
          target: { checked },
        } = event;

        const adsForm = $("#gAdsSetup"),
          duration = 100;

        checked ? adsForm.show(duration) : adsForm.hide(duration);
      }

      async function getAdsAccounts() {
        await run({
          funcName: "",
        });
      }

      async function formChangeGaAccount() {
        const selId = "#GaAcc";

        const sAccId = $(selId).val();
        if (!sAccId) return;
        $("#Preloader1").show();

        const { status, properties } = await run({
          funcName: "getGaPropertiesArrByAcc",
          params: [sAccId],
          onFailure: (err) => {
            $(selId).find("option:first").prop("selected", true);

            $(selId).formSelect();

            resetSelectPropagation();

            showErrorMsg(err);
          },
        });

        if (!status) {
          return notify(
            `Failed to load Analytics properties!`,
            5e2,
            config.classes.notify.error
          );
        }

        handleChange("Prop")(properties);
      }

      const handleChange = (/** @type {string} */ id) => (data) => {
        $("#Preloader1").hide();

        const sel = document.getElementById(id);
        removeOptions(sel);

        const { length } = data;

        data.forEach(({ name, path }) => addOption(sel, name, path));

        $(sel).formSelect();

        resetSelectPropagation();
      };

      /**
       * @param {string} selId
       * @param {string} subSelId
       * @param {string} handlerName
       */
      const getEntities = (selId, subSelId, handlerName) => {
        const sAccPath = $(`#${selId}`).val();

        if (!sAccPath) return;

        $("#Preloader1").show();
        google.script.run
          .withFailureHandler((err) => {
            $(`#${selId}`).find("option:first").prop("selected", true);

            $(`#${selId}`).formSelect();

            resetSelectPropagation();

            showErrorMsg(err);
          })
          .withSuccessHandler(handleChange(subSelId))
          [handlerName](sAccPath);
      };

      const formChangeAccount = () =>
        getEntities("Acc", "Cont", "getConteinersArrByAcc");

      const formChangeContainer = () =>
        getEntities("Cont", "Work", "getWorkspacesArrByCont");

      function addOption(oListbox, text, value) {
        const oOption = document.createElement("option");
        oOption.appendChild(document.createTextNode(text));
        oOption.setAttribute("value", value);
        oListbox.appendChild(oOption);
      }

      async function submitForm() {
        const sGaAcc = $("#GaAcc").val();
        const sProfileId = $("#Prop").val();
        const sAccValue = $("#Acc").val();
        const sContValue = $("#Cont").val();
        const sWorkValue = $("#Work").val();

        const sMyCategory = $("#MyCategory").val() || "Call";
        const sMyEvent = $("#MyEvent").val() || "Call";

        const issues = [];

        if (!sGaAcc) issues.push("Please select an Analytics Account!");
        if (!sProfileId) issues.push("Please select an Analytics Property!");
        if (!sAccValue) issues.push("Please select a Tag Manager Account!");
        if (!sContValue) issues.push("Please select a Container!");
        if (!sWorkValue) issues.push("Please select a Workspace!");

        const { error } = config.classes.notify;

        if (issues.length)
          return issues.forEach((msg) => notify(msg, 4e3, error));

        $("#Preloader1").show();

        await run({
          funcName: "deployAddon",
          params: [
            sProfileId,
            sContValue,
            sWorkValue,
            sMyCategory,
            sMyEvent,
            sAccValue,
          ],
          onSuccess: closeForm,
          onFailure: showErrorMsg,
        });
      }

      function showErrorMsg({ message }) {
        $("#Preloader1").hide();

        notify(
          `Add-on Failure:<br>"${message}<br>This is unexpected! We are already fixing this`,
          1e4,
          config.classes.notify.error
        );
      }

      const closeForm = () => google.script.host.close();

      $(document).on("click", "#toast-container .toast", ({ target }) => {
        $(this).fadeOut(() => M.Toast.getInstance(target).remove());
      });
    </script>
  </body>
</html>
