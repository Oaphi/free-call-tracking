<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA install</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons">

    <?!= style ?>
</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col s12 m4 l6">

                <p>Analytics not configured on one of the sites.
                    Would you like to create a Universal Analytics tag?</p>

                <a id="yes" class="waves-effect waves-light btn primary-background">Yes</a>
                <a id="no" class="waves-effect waves-light btn primary-background">No</a>

                <div id="preload" class="progress primary-background hide">
                    <div class="indeterminate primary-background"></div>
                </div>

            </div>
        </div>
    </div>

    <?!= run ?>

    <script type="text/javascript">

        const show = ({ classList }, className = "hide") => classList.remove(className);
        const hide = ({ classList }, className = "hide") => classList.add(className);
        const notify = (msg, ...classes) => M.toast({ html: msg, classes });

        const close = (cond = true) => cond && google.script.host.close();

        (() => {

            M.AutoInit();

            const yes = document.querySelector("#yes");
            yes.addEventListener("click", async ({ target }) => {
                const preload = document.querySelector("#preload");

                try {
                    show(preload);

                    const status = await run({ funcName: "installGAtag" });
                    notify(status ? "Successfully installed" : "Failed to install");

                } catch (error) {
                    notify("Something went wrong during install");
                }

                hide(preload);
            });

            const no = document.querySelector("#no");
            no.addEventListener("click", async () => {
                const preload = document.querySelector("#preload");

                show(preload);

                const result = await run({ funcName: "setGaInstallDismissed" });

                hide(preload);

                if (!result) {
                    return notify(`Failed to save preference (you will be prompted again if no UA tag is found)`);
                }

                close();
            });

        })();

    </script>

</body>

</html>